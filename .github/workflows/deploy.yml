name: Deploy Jekyll to Server

on:
  push:
    branches:
      - master
  workflow_dispatch:

permissions:
  contents: read

jobs:
  build-and-deploy:
    environment: master
    runs-on: ubuntu-latest
    env:
      DEPLOY_HOST: ${{ vars.DEPLOY_HOST }}
      DEPLOY_USER: ${{ vars.DEPLOY_USER }}
      DEPLOY_PORT: ${{ vars.DEPLOY_PORT }}
      DEPLOY_PATH: ${{ vars.DEPLOY_PATH }}
      SSH_OPTS: -P ${{ vars.DEPLOY_PORT }} -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null
      SSH_DEST: ${{ vars.DEPLOY_USER }}@${{ vars.DEPLOY_HOST }}
      SCP_OPTS: -P ${{ vars.DEPLOY_PORT }} -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Ruby
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: 3.2
          bundler-cache: true

      - name: Build Jekyll site
        run: |
          bundle exec jekyll build
        env:
          JEKYLL_ENV: production

      - name: Verify build output
        run: |
          if [ ! -d "output" ]; then
            echo "ERROR: output directory not created!"
            exit 1
          fi
          echo "Build output size: $(du -sh output | cut -f1)"
          echo "Files in output: $(find output -type f | wc -l)"

      - name: Install sshpass
        run: |
          sudo apt-get update -qq
          sudo apt-get install -y sshpass

      - name: Setup SSH for password-based authentication
        run: |
          mkdir -p ~/.ssh
          chmod 700 ~/.ssh
          
          # Disable host key checking for password-based auth (SCP compatibility)
          # GitHub's runner is in a clean environment, so this is safe
          cat > ~/.ssh/config << EOF
          Host deploy
            HostName $DEPLOY_HOST
            Port $DEPLOY_PORT
            User $DEPLOY_USER
            StrictHostKeyChecking no
            UserKnownHostsFile=/dev/null
          EOF
          chmod 600 ~/.ssh/config

      - name: Test SCP connection
        run: |
          echo "Testing SCP connection to $DEPLOY_USER@$DEPLOY_HOST:$DEPLOY_PORT"

          sshpass -p "${{ secrets.DEPLOY_SSH_PASSWORD }}" \
            ssh -v $SSH_OPTS "$SSH_DEST" \
            "echo 'SSH connection successful' && pwd" || {
              echo "✗ SSH connection failed"
              echo "Check:"
              echo "  - DEPLOY_HOST: $DEPLOY_HOST"
              echo "  - DEPLOY_USER: $DEPLOY_USER"
              echo "  - DEPLOY_PORT: $DEPLOY_PORT"
              echo "  - Password length: $(echo -n '${{ secrets.DEPLOY_SSH_PASSWORD }}' | wc -c)"
              exit 1
            }
          echo "✓ SSH connection successful"

      - name: Deploy to staging via SCP
        id: deploy
        run: |
          DEPLOY_RUN_ID="${{ github.run_id }}"
          STAGING_DIR="$DEPLOY_PATH/.deploy_tmp_${DEPLOY_RUN_ID}"
          
          echo "STAGING_DIR=${STAGING_DIR}" >> $GITHUB_OUTPUT
          echo "STAGING_NAME=.deploy_tmp_${DEPLOY_RUN_ID}" >> $GITHUB_OUTPUT
          
          # Create staging directory
          sshpass -p "${{ secrets.DEPLOY_SSH_PASSWORD }}" \
            ssh $SSH_OPTS "$SSH_DEST" \
            "mkdir -p ${STAGING_DIR}" || exit 1
          
          # Upload new site content to staging directory using SCP
          # Enable dotglob to include hidden files like .htaccess and .well-known/
          shopt -s dotglob
          sshpass -p "${{ secrets.DEPLOY_SSH_PASSWORD }}" \
            scp $SCP_OPTS -r \
            output/* "$SSH_DEST:${STAGING_DIR}/" || exit 1
          
          echo "✓ Files uploaded to staging: ${STAGING_DIR}"

      - name: Purge old backups
        run: |
          sshpass -p "${{ secrets.DEPLOY_SSH_PASSWORD }}" \
            ssh $SSH_OPTS "$SSH_DEST" \
            "cd '$DEPLOY_PATH' && find . -maxdepth 1 -type d -name '.backup_*' -exec rm -rfv {} \; 2>/dev/null || echo 'No previous backups to remove'"

      - name: Atomic swap via rename
        id: swap
        run: |
          STAGING_NAME="${{ steps.deploy.outputs.STAGING_NAME }}"
          DEPLOY_PATH="$DEPLOY_PATH"
          BACKUP_NAME=".backup_$(date +%s)"
          echo "BACKUP_NAME=${BACKUP_NAME}" >> $GITHUB_OUTPUT
          
          echo "Performing atomic rename-swap..."
          echo "  From: $STAGING_NAME"
          echo "  To: htdocs"
          echo "  Backup: $BACKUP_NAME (if old site exists)"

          # Atomic rename: back up current, promote staging
          sshpass -p "${{ secrets.DEPLOY_SSH_PASSWORD }}" \
            ssh $SSH_OPTS "$SSH_DEST" "bash -s" <<EOF
          set -e
          cd "$DEPLOY_PATH"

          if [ -d htdocs ]; then
            mv htdocs "$BACKUP_NAME"
            echo "✓ Old site backed up to $BACKUP_NAME"
          else
            echo "No old site to backup"
          fi

          mv "$STAGING_NAME" htdocs
          echo "✓ New site is live"
          EOF

      - name: Verify deployment from build agent
        run: |
          # Give the web server a moment to pick up the new files
          sleep 2

          # Test from build agent (not via SSH) - fail if the site doesn't respond
          curl -f \
               --connect-timeout 5 \
               --max-time 15 \
               -s -o /dev/null \
               -w '%{http_code}' \
               "https://$DEPLOY_HOST/index.html" \
            && echo '✓ Site is responding' \
            || { echo 'ERROR: Site verification failed'; exit 1; }

      - name: Cleanup on failure (rollback)
        if: failure()
        run: |
          STAGING_NAME="${{ steps.deploy.outputs.STAGING_NAME }}"
          BACKUP_NAME="${{ steps.swap.outputs.BACKUP_NAME }}"
          DEPLOY_PATH="$DEPLOY_PATH"

          echo "⚠ Deployment failed. Attempting rollback..."

          # Restore previous site from backup and tidy up staging
          sshpass -p "${{ secrets.DEPLOY_SSH_PASSWORD }}" \
            ssh $SSH_OPTS "$SSH_DEST" "bash -s" <<EOF
          set -e
          cd "$DEPLOY_PATH"

          if [ -d "$BACKUP_NAME" ]; then
            echo 'Rolling back to previous site...'
            [ -d htdocs ] && mv htdocs .failed_${{ github.run_id }} || true
            mv "$BACKUP_NAME" htdocs
            echo '✓ Rolled back to previous site'
          else
            echo 'No backup found to rollback.'
          fi

          [ -n "$STAGING_NAME" ] && [ -d "$STAGING_NAME" ] && rm -rf "$STAGING_NAME" || true
          EOF

          echo "Rollback step completed. Check logs for details."

      - name: Deployment summary
        if: success()
        run: |
          echo "✅ Deployment to $DEPLOY_HOST:$DEPLOY_PATH/htdocs completed successfully"
          echo "Run ID: ${{ github.run_id }}"
          echo "Commit: ${{ github.sha }}"
