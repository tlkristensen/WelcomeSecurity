name: Website health check

on:
  schedule:
    - cron: "0 3 * * *"   # hver nat kl. 03:00 UTC
  workflow_dispatch: {}

permissions:
  contents: read
  issues: write  # For creating issues on failure (optional)

jobs:
  check:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Ruby
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: '3.2'
          bundler-cache: true

      - name: Build site (Jekyll)
        run: |
          bundle exec jekyll build --destination output

      - name: Check site availability and response time
        id: availability
        run: |
          echo "## Site Availability Test" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          START=$(date +%s)
          HTTP_CODE=$(curl -fsSL -w '%{http_code}' -o /tmp/response.html \
                      --max-time 20 \
                      https://www.welcomesecurity.net)
          END=$(date +%s)
          DURATION=$((END - START))
          
          echo "**Status:** âœ… Site is reachable" >> $GITHUB_STEP_SUMMARY
          echo "**HTTP Code:** $HTTP_CODE" >> $GITHUB_STEP_SUMMARY
          echo "**Response time:** ${DURATION}s" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ $DURATION -gt 5 ]; then
            echo "âš ï¸ **Warning:** Response time is slow (>${DURATION}s)" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
          fi

      - name: Check SSL certificate
        id: ssl
        run: |
          echo "## SSL Certificate Check" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          EXPIRY=$(echo | openssl s_client -servername www.welcomesecurity.net \
                   -connect www.welcomesecurity.net:443 2>/dev/null \
                   | openssl x509 -noout -enddate | cut -d= -f2)
          
          EXPIRY_EPOCH=$(date -d "$EXPIRY" +%s)
          NOW_EPOCH=$(date +%s)
          DAYS_LEFT=$(( ($EXPIRY_EPOCH - $NOW_EPOCH) / 86400 ))
          
          echo "**Expires:** $EXPIRY" >> $GITHUB_STEP_SUMMARY
          echo "**Days remaining:** $DAYS_LEFT" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ $DAYS_LEFT -lt 30 ]; then
            echo "âš ï¸ **WARNING:** Certificate expires in less than 30 days!" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            exit 1
          else
            echo "âœ… Certificate is valid" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
          fi

      - name: Link check (internal & external)
        id: links
        uses: lycheeverse/lychee-action@v2.0.2
        with:
          args: >
            --verbose
            --no-progress
            --timeout 20
            --max-redirects 5
            --accept 200,204,301,302
            --exclude "https://fonts.gstatic.com"
            --exclude "https://fonts.googleapis.com"
            --exclude "https://www.linkedin.com"
            ./output/
            https://www.welcomesecurity.net/sitemap.xml
            https://www.welcomesecurity.net
          output: lychee-report.md
          fail: true

      - name: Locate failing links in build
        if: always()
        run: |
          if [ ! -f lychee-report.md ] || [ ! -d output ]; then
            echo "No lychee report or build output present; skipping source lookup.";
            exit 0;
          fi

          echo "Broken links and where they appear (searching ./output):"
          grep -oP '\[\d{3}\]\s+\Khttps?://\S+' lychee-report.md | while read -r url; do
            echo "\n=== $url ==="
            rg -n "$url" output || echo "Not found in built output"
          done

      - name: Upload link check report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: link-check-report
          path: lychee-report.md
          retention-days: 30

      - name: Final summary
        if: always()
        run: |
          echo "## Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "âœ… All checks completed successfully" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Timestamp:** $(date -u '+%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ“Š [View link check report in artifacts](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})" >> $GITHUB_STEP_SUMMARY
