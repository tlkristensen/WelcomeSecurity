name: Website health check

on:
  schedule:
    - cron: "0 3 * * *"   # hver nat kl. 03:00 UTC
  workflow_dispatch: {}

permissions:
  contents: read
  issues: write  # For creating issues on failure (optional)

jobs:
  check:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Ruby
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: '3.2'
          bundler-cache: true

      - name: Build site (Jekyll)
        run: |
          bundle exec jekyll build --destination output

      - name: Check site availability and response time
        id: availability
        run: |
          echo "## Site Availability Test" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          START=$(date +%s)
          HTTP_CODE=$(curl -fsSL -w '%{http_code}' -o /tmp/response.html \
                      --max-time 20 \
                      https://www.welcomesecurity.net)
          END=$(date +%s)
          DURATION=$((END - START))
          
          echo "**Status:** ✅ Site is reachable" >> $GITHUB_STEP_SUMMARY
          echo "**HTTP Code:** $HTTP_CODE" >> $GITHUB_STEP_SUMMARY
          echo "**Response time:** ${DURATION}s" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ $DURATION -gt 5 ]; then
            echo "⚠️ **Warning:** Response time is slow (>${DURATION}s)" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
          fi

      - name: Check SSL certificate
        id: ssl
        run: |
          echo "## SSL Certificate Check" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          EXPIRY=$(echo | openssl s_client -servername www.welcomesecurity.net \
                   -connect www.welcomesecurity.net:443 2>/dev/null \
                   | openssl x509 -noout -enddate | cut -d= -f2)
          
          EXPIRY_EPOCH=$(date -d "$EXPIRY" +%s)
          NOW_EPOCH=$(date +%s)
          DAYS_LEFT=$(( ($EXPIRY_EPOCH - $NOW_EPOCH) / 86400 ))
          
          echo "**Expires:** $EXPIRY" >> $GITHUB_STEP_SUMMARY
          echo "**Days remaining:** $DAYS_LEFT" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ $DAYS_LEFT -lt 30 ]; then
            echo "⚠️ **WARNING:** Certificate expires in less than 30 days!" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            exit 1
          else
            echo "✅ Certificate is valid" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
          fi

      - name: Link check (internal & external)
        id: links
        uses: lycheeverse/lychee-action@v2.0.2
        with:
          args: >
            --verbose
            --no-progress
            --timeout 20
            --max-redirects 5
            --accept 200,204,301,302
            --exclude "https://fonts.gstatic.com"
            --exclude "https://fonts.googleapis.com"
            --exclude "https://www.linkedin.com"
            ./output/
            https://www.welcomesecurity.net/sitemap.xml
            https://www.welcomesecurity.net
          output: lychee-report.md
          fail: true

      - name: Locate failing links in build
        if: always()
        run: |
          echo "## Broken links (source files)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ ! -f lychee-report.md ] || [ ! -d output ]; then
            echo "No lychee report or build output found." >> $GITHUB_STEP_SUMMARY
            exit 0
          fi

          # Extract failed URLs from lychee report
          BROKEN_URLS=$(grep -oP '\[\d{3}\]\s+\K\S+' lychee-report.md | sort -u)

          if [ -z "$BROKEN_URLS" ]; then
            echo "No broken links found in report." >> $GITHUB_STEP_SUMMARY
            exit 0
          fi

          while IFS= read -r url; do
            echo "### \`$url\`" >> $GITHUB_STEP_SUMMARY
            # Search for this URL in all built HTML files
            RESULTS=$(rg -F "$url" output --type html --color never 2>/dev/null)
            if [ -n "$RESULTS" ]; then
              echo "**Found in:**" >> $GITHUB_STEP_SUMMARY
              echo "$RESULTS" | sed 's/^/- /' >> $GITHUB_STEP_SUMMARY
            else
              echo "- Not found in built files" >> $GITHUB_STEP_SUMMARY
            fi
            echo "" >> $GITHUB_STEP_SUMMARY
          done <<< "$BROKEN_URLS"

      - name: Final summary
        if: always()
        run: |
          echo "## Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Run finished at $(date -u '+%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_STEP_SUMMARY
